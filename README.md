# MOJ FastAPI Skeleton

[![Ministry of Justice Repository Compliance Badge](https://github-community.service.justice.gov.uk/repository-standards/api/moj-fastapi-template/badge)](https://github-community.service.justice.gov.uk/repository-standards/moj-fastapi-template)

The MOJ FastAPI Skeleton is a foundation for teams to kick-start development of FastAPI based REST APIs.

This skeleton contains example implementations of the following features:

- A [FastAPI](https://fastapi.tiangolo.com/) based REST API with CRUD operations
- - Autogenerated [Swagger](https://swagger.io/) and [Redoc](https://github.com/Redocly/redoc) API documentation
- Database models using [SQLModel](https://sqlmodel.tiangolo.com/), a wrapper of SQLAlchemy, allowing you to easily define related request, response and DB schema models
- - Automatic type validation by [Pydantic](https://docs.pydantic.dev/latest/)
- Autogenerated database migrations with [Alembic](https://alembic.sqlalchemy.org/en/latest/)
- Authentication with JSON Web Tokens for OAuth 2.0
- A Dockerfile and Docker Compose for one step local development
- Unit tests with a test HTTP client and an in-memory testing database
- [SonarCloud](https://www.sonarsource.com/products/sonarcloud/) and [Sentry](https://sentry.io/) support
- A CI/CD Pipeline and Helm Charts for deploying to the MOJ's [Cloud Platform](https://user-guide.cloud-platform.service.justice.gov.uk/)

## Documentation

The API docs are autogenerated from Python's type hints and Pydantic fields.

Documentation about how to use and build on this skeleton can be found here:

- [Models](./app/models/README.md)

- [Migrations](app/db/migrations/README.md)

- [Routers](app/routers/README.md)

- [Testing](./tests/README.md)

- [Helm Charts](./helm_deploy/README.md)

- [GitHub Actions Pipeline](.github/workflows/README.md)

This API was built and maintained by the Civil Legal Advice team.

If you need any further help using this skeleton please feel free to reach out to us in the [#laa-cla-dev](https://moj.enterprise.slack.com/archives/CFUESB43G) Slack channel.

If you build anything with this skeleton we would love to hear about it!

## Running the API

It is recommended to use Docker to run the app and database.

```bash
./run_local.sh
```

This command:

- Builds the containers for the app and database
- Migrates the database to the latest version
- Reloads the app whenever changes are made within the `/app` directory

#### The API docs can then be found at: [localhost:8027](http://localhost:8027)

> If you run into any issues please see [TROUBLESHOOT.md](TROUBLESHOOT.md).
___

## Adding an authorised user

An authorised user is created as part of the run_local script.

The created user will have the following credentials:

- **Username:** test_user
- **Password:** test_password

___

## Running in a virtual environment

If you wish to run the app in a virtual environment you will first require Python 3.12.

You can see your Python version with:

```bash
python3 -V
```

If you are  running below Python 3.12 you can install it manually or use pyenv.

```bash
brew install pyenv
pyenv install 3.12
pyenv global 3.12
```

You can then start a virtual environment with:

```bash
python3 -m venv .venv
source .venv/bin/activate
```

And install the requirements using

```bash
pip install -r requirements/generated/requirements-development.txt
```

If you encounter issues such as `ModuleNotFoundError` restart your terminal session.

### Running the database

To start a Postgres DB run:

```bash
docker compose up db -d
```

To migrate the database to the latest revision run:

```bash
alembic upgrade head
```

To run the web server run:

```shell
uvicorn app:api --reload
```

---

## Docs

Swagger API documentation can be found at the `/` or `/docs` endpoint.
Redoc documentation can be found at the `/redoc` endpoint.

___

## Tests

To install testing dependencies run:

```bash
pip install -r requirements/generated/requirements-testing.txt
```

Tests are managed using Pytest and can be run by using:

```bash
pytest
```

All tests use a mocked user that circumvents the authorisation.

For information on writing tests please see [here](./tests/README.md).

## Code formatting and linting

The following will:

- Generate requirement.txt files from files inside `requirements/source/*.in` and put them into `requirements/generated/*.txt`
- Run linting checks with ruff

```bash
pre-commit install
```

### Manually running linting

The Ruff linter looks for code quality issues. Ensure there are no ruff issues before committing.

To lint all files in the directory, run:

```bash
ruff check
```

To format all files in the directory, run:

```bash
ruff format
```


## Git hooks

Repository uses [MoJ DevSecOps hooks](https://github.com/ministryofjustice/devsecops-hooks) to ensure `pre-commit` git hook is evaluated for series of checks before pushing the changes from staging area. Engineers should ensure `pre-commit` hook is configured and activated.

1. **Installation**:

   Ensure [prek](https://github.com/j178/prek?tab=readme-ov-file#installation) is installed globally

   Linux / MacOS

   ```bash
   curl --proto '=https' --tlsv1.2 -LsSf https://raw.githubusercontent.com/ministryofjustice/devsecops-hooks/e85ca6127808ef407bc1e8ff21efed0bbd32bb1a/prek/prek-installer.sh | sh
   ```

   or

   ```bash
   brew install prek
   ```

   Windows

   ```bash
   powershell -ExecutionPolicy ByPass -c "irm https://raw.githubusercontent.com/ministryofjustice/devsecops-hooks/e85ca6127808ef407bc1e8ff21efed0bbd32bb1a/prek/prek-installer.ps1 | iex"
   ```

2. **Activation**

   Execute the following command in the repository directory

   ```bash
   prek install
   ```

3. **Test**

    To dry-run the hook

   ```bash
   prek run
   ```

## ðŸ”§ Configuration

### Exclusion list

One can exclude files and directories by adding them to `exclude` property. Exclude property accepts [regular expression](https://pre-commit.com/#regular-expressions).

Ignore everything under `reports` and `docs` directories for `baseline` hook as an example.

```yaml
   repos:
     - repo: https://github.com/ministryofjustice/devsecops-hooks
       rev: v1.0.0
       hooks:
         - id: baseline
            exclude: |
            ^reports/|
            ^docs/
```

Or one can also create a file with list of exclusions.

```yaml
repos:
  - repo: https://github.com/ministryofjustice/devsecops-hooks
    rev: v1.0.0
    hooks:
      - id: baseline
        exclude: .pre-commit-ignore
```
